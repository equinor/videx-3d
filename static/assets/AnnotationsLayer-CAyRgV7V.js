import{j as M}from"./jsx-runtime-CmIOflP4.js";import{r as b}from"./index-KqYmeiyw.js";import{c as Mt}from"./client-CjwNmqqA.js";import{V as H,i as xt,_ as vt,O as wt,G as St,Q as At,K as Pt,y as Bt,$ as qt}from"./CameraManager-BuezL_By.js";import"./index.esm-BMr5xbKZ.js";import{c as I,d as et,P as E,f as Yt,g as Xt,a as It,u as Vt,T as Tt}from"./canvas-3d-decorator-BhyssXtK.js";import"./index-BsNHLAmC.js";import{g as Et}from"./uv-material-DyQCcDTL.js";import"./limiter-DhBcc_yH.js";import{c as Ct,u as kt}from"./react-Mgt78q4a.js";import{c as Lt}from"./numbers-DM6OWwIG.js";function Me(i,e){return[i[0]-e[0],i[1]-e[1],i[2]-e[2]]}function ve(i,e){return[i[1]*e[2]-i[2]*e[1],i[2]*e[0]-i[0]*e[2],i[0]*e[1]-i[1]*e[0]]}function Rt(i){const e=Math.sqrt(i[0]*i[0]+i[1]*i[1]+i[2]*i[2]);return i[0]=i[0]/e,i[1]=i[1]/e,i[2]=i[2]/e,i}function Ot(i){const e=Math.sqrt(i[0]*i[0]+i[1]*i[1]);return i[0]=i[0]/e,i[1]=i[1]/e,i}function Ft(i,e){return[i[0]-e[0],i[1]-e[1]]}function bt(i,e,t=.5){const n=1-t;return[i[0]*n+e[0]*t,i[1]*n+e[1]*t]}const Ht=i=>(e,t,n)=>{const a=n.subscribe;return n.subscribe=(r,l,u)=>{let o=r;if(l){const c=(u==null?void 0:u.equalityFn)||Object.is;let d=r(n.getState());o=p=>{const f=r(p);if(!c(d,f)){const m=d;l(d=f,m)}},u!=null&&u.fireImmediately&&l(d,d)}return a(o)},i(e,t,n)},Wt=Ht,_=Ct(Wt((i,e)=>({visible:!0,update:{required:!1,ref:null,setRef:t=>i(n=>({update:{...n.update,ref:t}}))},layers:{},annotations:{},instances:[],clear:()=>i({layers:{},annotations:{},instances:[]}),setInstances:t=>i({instances:t}),layerExist:t=>!!e().layers[t],toggleVisibility:()=>{i(t=>({visible:!t.visible,update:{...t.update,required:!0}}))},createLayer:t=>{const n=t.id;return i(a=>{const s=a.layers;if(s[n])throw Error("Layer already exist!");return{layers:{...s,[n]:t}}}),()=>{i(a=>{const s={...a.layers};return delete s[n],{layers:s,update:{...a.update,required:!0}}})}},updateLayer:(t,n)=>{i(a=>{const s=a.layers;if(!s[t])throw Error("Layer does not exist!");return{layers:{...s,[t]:{...s[t],...n}},update:{...a.update,required:!0}}})},addLayerAnnotations:(t,n,a)=>{i(s=>{a.forEach(o=>{o.scope=n});const r=s.annotations,l=r[t]?r[t].filter(o=>o.scope!==n):[];return{annotations:{...r,[t]:[...l,...a]},update:{...s.update,required:!0}}})},removeLayerAnnotations:(t,n)=>{i(a=>{const s=a.annotations,r=s[t]?s[t].filter(l=>l.scope!==n):[];return{annotations:{...s,[t]:r},update:{...a.update,required:!0}}})}}))),zt=()=>{_.setState(i=>{if(!i.visible)return{instances:[],update:{...i.update,required:!1,ref:null}};const e=i.layers,t=new Map(i.instances.map(r=>[r.id,r])),n=[],a=[0,0];Object.keys(e).forEach(r=>{var u;const l=e[r];l.visible&&((u=i.annotations[r])==null||u.forEach(o=>{const c=`${r}_${o.scope}_${o.id}`;let d;const p=t.get(c);p?(d=p,d.annotation.name=o.name,d.annotation.data=o.data,d.annotation.direction=o.direction,d.annotation.position=o.position,d.annotation.priority=o.priority):d={id:c,ref:l.labelComponent?b.createRef():null,layer:l,annotation:o,priority:0,rank:0,state:{visible:!1,distance:1/0,health:0,labelWidht:0,labelHeight:0,screenPosition:[0,0,0],zIndex:0}},d.priority=(o.priority||0)+(l.priority||0),a[0]=Math.min(a[0],d.priority),a[1]=Math.max(a[1],d.priority),n.push(d)}))});const s=Math.abs(a[1]-a[0]);return n.forEach(r=>{r.priority=s>0?(r.priority-a[0])/s:0}),{instances:n,update:{...i.update,required:!1,ref:null}}})};_.subscribe(i=>i.update.required,i=>{if(i){const e=_.getState().update;e.ref&&clearTimeout(e.ref);const t=setTimeout(()=>zt(),500);e.setRef(t)}});const we=(i,e)=>{const t=_(a=>a.addLayerAnnotations),n=_(a=>a.removeLayerAnnotations);return{addAnnotations:a=>(t(i,e,a),()=>n(i,e))}},Dt={pointerEvents:"none",width:"100%",height:"100%"},Ut={position:"absolute",top:0,left:0,visibility:"hidden",userSelect:"none",cursor:"pointer",pointerEvents:"visible"},$t=b.forwardRef(({id:i,state:e,layer:t,annotation:n},a)=>{const s=b.useCallback(()=>{t.onClick&&t.onClick({instanceId:i,...n})},[n,i,t]),r=b.useCallback(()=>{e.labelHovered=!0},[e]),l=b.useCallback(()=>{e.labelHovered=!1},[e]);return M.jsx("div",{ref:a,style:Ut,onClick:s,onPointerEnter:r,onPointerLeave:l,children:t.labelComponent&&M.jsx(t.labelComponent,{instanceId:i,...n})})}),Nt=()=>{const i=kt(_,e=>e.instances);return M.jsx("div",{style:Dt,children:i.map(e=>M.jsx($t,{ref:e.ref,id:e.id,state:e.state,layer:e.layer,annotation:e.annotation},e.id))})};function jt(i,e,t,n,a){gt(i,e,t||0,n||i.length-1,a||Qt)}function gt(i,e,t,n,a){for(;n>t;){if(n-t>600){var s=n-t+1,r=e-t+1,l=Math.log(s),u=.5*Math.exp(2*l/3),o=.5*Math.sqrt(l*u*(s-u)/s)*(r-s/2<0?-1:1),c=Math.max(t,Math.floor(e-r*u/s+o)),d=Math.min(n,Math.floor(e+(s-r)*u/s+o));gt(i,e,c,d,a)}var p=i[e],f=t,m=n;for(X(i,t,e),a(i[n],p)>0&&X(i,t,n);f<m;){for(X(i,f,m),f++,m--;a(i[f],p)<0;)f++;for(;a(i[m],p)>0;)m--}a(i[t],p)===0?X(i,t,m):(m++,X(i,m,n)),m<=e&&(t=m+1),e<=m&&(n=m-1)}}function X(i,e,t){var n=i[e];i[e]=i[t],i[t]=n}function Qt(i,e){return i<e?-1:i>e?1:0}class _t{constructor(e=9){this._maxEntries=Math.max(4,e),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(e){let t=this.data;const n=[];if(!L(e,t))return n;const a=this.toBBox,s=[];for(;t;){for(let r=0;r<t.children.length;r++){const l=t.children[r],u=t.leaf?a(l):l;L(e,u)&&(t.leaf?n.push(l):D(e,u)?this._all(l,n):s.push(l))}t=s.pop()}return n}collides(e){let t=this.data;if(!L(e,t))return!1;const n=[];for(;t;){for(let a=0;a<t.children.length;a++){const s=t.children[a],r=t.leaf?this.toBBox(s):s;if(L(e,r)){if(t.leaf||D(e,r))return!0;n.push(s)}}t=n.pop()}return!1}load(e){if(!(e&&e.length))return this;if(e.length<this._minEntries){for(let n=0;n<e.length;n++)this.insert(e[n]);return this}let t=this._build(e.slice(),0,e.length-1,0);if(!this.data.children.length)this.data=t;else if(this.data.height===t.height)this._splitRoot(this.data,t);else{if(this.data.height<t.height){const n=this.data;this.data=t,t=n}this._insert(t,this.data.height-t.height-1,!0)}return this}insert(e){return e&&this._insert(e,this.data.height-1),this}clear(){return this.data=Y([]),this}remove(e,t){if(!e)return this;let n=this.data;const a=this.toBBox(e),s=[],r=[];let l,u,o;for(;n||s.length;){if(n||(n=s.pop(),u=s[s.length-1],l=r.pop(),o=!0),n.leaf){const c=Gt(e,n.children,t);if(c!==-1)return n.children.splice(c,1),s.push(n),this._condense(s),this}!o&&!n.leaf&&D(n,a)?(s.push(n),r.push(l),l=0,u=n,n=n.children[0]):u?(l++,n=u.children[l],o=!1):n=null}return this}toBBox(e){return e}compareMinX(e,t){return e.minX-t.minX}compareMinY(e,t){return e.minY-t.minY}toJSON(){return this.data}fromJSON(e){return this.data=e,this}_all(e,t){const n=[];for(;e;)e.leaf?t.push(...e.children):n.push(...e.children),e=n.pop();return t}_build(e,t,n,a){const s=n-t+1;let r=this._maxEntries,l;if(s<=r)return l=Y(e.slice(t,n+1)),B(l,this.toBBox),l;a||(a=Math.ceil(Math.log(s)/Math.log(r)),r=Math.ceil(s/Math.pow(r,a-1))),l=Y([]),l.leaf=!1,l.height=a;const u=Math.ceil(s/r),o=u*Math.ceil(Math.sqrt(r));it(e,t,n,o,this.compareMinX);for(let c=t;c<=n;c+=o){const d=Math.min(c+o-1,n);it(e,c,d,u,this.compareMinY);for(let p=c;p<=d;p+=u){const f=Math.min(p+u-1,d);l.children.push(this._build(e,p,f,a-1))}}return B(l,this.toBBox),l}_chooseSubtree(e,t,n,a){for(;a.push(t),!(t.leaf||a.length-1===n);){let s=1/0,r=1/0,l;for(let u=0;u<t.children.length;u++){const o=t.children[u],c=z(o),d=Zt(e,o)-c;d<r?(r=d,s=c<s?c:s,l=o):d===r&&c<s&&(s=c,l=o)}t=l||t.children[0]}return t}_insert(e,t,n){const a=n?e:this.toBBox(e),s=[],r=this._chooseSubtree(a,this.data,t,s);for(r.children.push(e),T(r,a);t>=0&&s[t].children.length>this._maxEntries;)this._split(s,t),t--;this._adjustParentBBoxes(a,s,t)}_split(e,t){const n=e[t],a=n.children.length,s=this._minEntries;this._chooseSplitAxis(n,s,a);const r=this._chooseSplitIndex(n,s,a),l=Y(n.children.splice(r,n.children.length-r));l.height=n.height,l.leaf=n.leaf,B(n,this.toBBox),B(l,this.toBBox),t?e[t-1].children.push(l):this._splitRoot(n,l)}_splitRoot(e,t){this.data=Y([e,t]),this.data.height=e.height+1,this.data.leaf=!1,B(this.data,this.toBBox)}_chooseSplitIndex(e,t,n){let a,s=1/0,r=1/0;for(let l=t;l<=n-t;l++){const u=V(e,0,l,this.toBBox),o=V(e,l,n,this.toBBox),c=te(u,o),d=z(u)+z(o);c<s?(s=c,a=l,r=d<r?d:r):c===s&&d<r&&(r=d,a=l)}return a||n-t}_chooseSplitAxis(e,t,n){const a=e.leaf?this.compareMinX:Jt,s=e.leaf?this.compareMinY:Kt,r=this._allDistMargin(e,t,n,a),l=this._allDistMargin(e,t,n,s);r<l&&e.children.sort(a)}_allDistMargin(e,t,n,a){e.children.sort(a);const s=this.toBBox,r=V(e,0,t,s),l=V(e,n-t,n,s);let u=k(r)+k(l);for(let o=t;o<n-t;o++){const c=e.children[o];T(r,e.leaf?s(c):c),u+=k(r)}for(let o=n-t-1;o>=t;o--){const c=e.children[o];T(l,e.leaf?s(c):c),u+=k(l)}return u}_adjustParentBBoxes(e,t,n){for(let a=n;a>=0;a--)T(t[a],e)}_condense(e){for(let t=e.length-1,n;t>=0;t--)e[t].children.length===0?t>0?(n=e[t-1].children,n.splice(n.indexOf(e[t]),1)):this.clear():B(e[t],this.toBBox)}}function Gt(i,e,t){if(!t)return e.indexOf(i);for(let n=0;n<e.length;n++)if(t(i,e[n]))return n;return-1}function B(i,e){V(i,0,i.children.length,e,i)}function V(i,e,t,n,a){a||(a=Y(null)),a.minX=1/0,a.minY=1/0,a.maxX=-1/0,a.maxY=-1/0;for(let s=e;s<t;s++){const r=i.children[s];T(a,i.leaf?n(r):r)}return a}function T(i,e){return i.minX=Math.min(i.minX,e.minX),i.minY=Math.min(i.minY,e.minY),i.maxX=Math.max(i.maxX,e.maxX),i.maxY=Math.max(i.maxY,e.maxY),i}function Jt(i,e){return i.minX-e.minX}function Kt(i,e){return i.minY-e.minY}function z(i){return(i.maxX-i.minX)*(i.maxY-i.minY)}function k(i){return i.maxX-i.minX+(i.maxY-i.minY)}function Zt(i,e){return(Math.max(e.maxX,i.maxX)-Math.min(e.minX,i.minX))*(Math.max(e.maxY,i.maxY)-Math.min(e.minY,i.minY))}function te(i,e){const t=Math.max(i.minX,e.minX),n=Math.max(i.minY,e.minY),a=Math.min(i.maxX,e.maxX),s=Math.min(i.maxY,e.maxY);return Math.max(0,a-t)*Math.max(0,s-n)}function D(i,e){return i.minX<=e.minX&&i.minY<=e.minY&&e.maxX<=i.maxX&&e.maxY<=i.maxY}function L(i,e){return e.minX<=i.maxX&&e.minY<=i.maxY&&e.maxX>=i.minX&&e.maxY>=i.minY}function Y(i){return{children:i,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function it(i,e,t,n,a){const s=[e,t];for(;s.length;){if(t=s.pop(),e=s.pop(),t-e<=n)continue;const r=e+Math.ceil((t-e)/n/2)*n;jt(i,r,e,t,a),s.push(e,r,r,t)}}const R=new H,ee=[0,I,et,E-I,E,-E+I,-et,-I],ie=[[2,6],[7,3],[0,4],[1,5]],ne=(i,e,t,n)=>{R.set(e[0]+t[0]*100,e[1]+t[1]*100,e[2]+t[2]*100),R.project(n);const a=Ot(Ft([R.x,R.y],[i[0],i[1]]));let s=Math.atan2(a[1],a[0]);return s<0&&(s=E+s),Math.floor((s+Yt)/I)%4},oe=(i,e,t,n)=>{const a=Math.floor((i[0]*.5+.5)*e),s=Math.floor((i[1]*.5+.5)*t),r=n[s*e+a];return r>-1&&r<i[2]},nt=[-.99,.99],ot=[-.99,.99],Z=1,at=Z*2,st=3,ae=5,se=new H,q=new H;let rt=0,U,$,N,j,Q;const lt=new _t,ut=new _t;function dt(i,e,t){const n=i.state.scaleFactor,a=ie[i.state.quadrant],s=ee[a[e]],r=i.state.labelWidht||0,l=i.state.labelHeight||0,u=r*n,o=l*n,c=Xt([u,o],s),d=[Math.cos(s),-Math.sin(s)],p=i.layer.labelOffset*n,f=[(i.state.screenPosition[0]*.5+.5)*t.x+d[0]*p,(-i.state.screenPosition[1]*.5+.5)*t.y+d[1]*p];i.state.anchorPosition=f,i.state.scaledOffset=[(r-u)/2,(l-o)/2],i.state.labelPosition=[f[0]-u/2+c[0],f[1]-o/2+c[1]]}function ct(i,e,t,n){i.state.visible&&(i.state.positionSlot!==e||i.state.prevQuadrant&&i.state.prevQuadrant!==i.state.quadrant)&&t&&(i.state.inTransition=!0,i.state.transitionTime=0,i.state.prevLabelPosition=t,n&&(i.state.prevAnchorPosition=n))}function re(i,e,t,n){const a=t.elapsedTime-rt,r=e.fov*E/180;e.getWorldDirection(se);let l=0;const u=[];return i.forEach((o,c)=>{o.state.capped=!1,o.state._needsUpdate=!1,o.state.visible||(o.state.health=0,o.state.prevAnchorPosition=void 0,o.state.prevLabelPosition=void 0),o.state.kill?o.state.health===0?(o.state.kill=!1,o.state.visible=!1):o.state.health>0&&(o.state.health=Math.max(0,o.state.health-a*st)):o.state.health<1&&(o.state.health=Math.min(1,Math.max(0,o.state.health+a*st))),o.state.inTransition&&(o.state.transitionTime+=a*ae,o.state.transitionTime>=1&&(o.state.inTransition=!1,o.state.transitionTime=0,o.state.prevAnchorPosition=void 0,o.state.prevLabelPosition=void 0)),q.set(...o.annotation.position);const d=q.distanceTo(e.position),p=Math.max(.25,Math.min(1,1/(2*Math.tan(r/2)*d)*o.layer.distanceFactor));q.project(e);const f=[q.x,q.y,q.z],m=f[2]>=0&&f[2]<=1&&f[0]>=nt[0]&&f[0]<=nt[1]&&f[1]>=ot[0]&&f[1]<=ot[1]&&(!o.layer.minDistance||d>=o.layer.minDistance)&&(!o.layer.maxDistance||d<=o.layer.maxDistance);if(o.state.screenPosition=f,o.state.distance=d,o.state.scaleFactor=p,o.state.inViewSpace=m,o.state.cooldown&&o.state.visible===!1)o.state.cooldown=Math.max(0,o.state.cooldown-a),o.rank=0;else{const v=Lt((f[0]**2+f[1]**2)/2,0,1),y=Math.min(d,1e3);o.rank=1e3,o.rank+=o.priority*1e3-(v*100+y),o.state.visible?o.rank+=100:o.rank-=100,m&&l<n?(l++,o.state.prevQuadrant=o.state.quadrant,o.state.quadrant=o.annotation.direction?ne(f,o.annotation.position,o.annotation.direction,e):0):(o.state.quadrant=0,o.state.visible=!1,c>=n&&(o.state.capped=!0))}o.state.boost&&(o.state.kill=!1,o.state.cooldown=0,o.state.visible=!0,o.rank+=1e5,o.state.positionSlot=0,o.state.boost=!1),o.state.inViewSpace&&!o.state.capped?u.push(o):o.state._visibility!=="hidden"&&(o.state.visible=!1,o.state._visibility="hidden",o.state._needsUpdate=!0)}),rt=t.elapsedTime,u.sort((o,c)=>c.rank-o.rank),u}async function le(i,e,t,n){i.forEach(a=>{const s=oe(a.position,t,n,e);!a.instance.state.occluded&&s&&(a.instance.state.kill=!0),a.instance.state.occluded=s})}function ue(i,e){lt.clear(),ut.clear(),i.forEach(t=>{var l;const n=t.state.labelPosition?[...t.state.labelPosition]:null,a=t.state.anchorPosition?[...t.state.anchorPosition]:null,s=t.state.positionSlot||0,r=(l=t.ref)==null?void 0:l.current;if(r&&(t.state.labelWidht=r.clientWidth,t.state.labelHeight=r.clientHeight),t.state.kill||t.state.occluded)dt(t,s,e),ct(t,s,n,a);else if(t.state.cooldown)t.state.visible=!1;else{let u=!1;const o=s===0?[0,1]:[1,0],c=t.state.labelWidht,d=t.state.labelHeight,p=c*t.state.scaleFactor,f=d*t.state.scaleFactor;for(let m=0;m<o.length;m++){dt(t,o[m],e);const v={minX:t.state.labelPosition[0]-Z,minY:t.state.labelPosition[1]-Z,maxX:t.state.labelPosition[0]+p+at,maxY:t.state.labelPosition[1]+f+at},y=t.state.scaleFactor>=.5?lt:ut;if(!y.collides(v)){y.insert(v),u=!0,ct(t,o[m],n,a),t.state.positionSlot=o[m];break}}u?t.state.visible=!0:(t.state.kill=!0,t.state.cooldown=2.5)}t.state.visible?(t.state.zIndex=t.state.labelHovered?1e6:t.state.kill?0:Math.round(1/t.state.distance*1e5),t.state.opacity=Math.max(.75,t.state.scaleFactor)*t.state.health,t.state.inTransition&&t.state.prevLabelPosition?[j,Q]=bt(t.state.prevLabelPosition,t.state.labelPosition,t.state.transitionTime):[j,Q]=t.state.labelPosition,t.state.labelX=j-t.state.scaledOffset[0],t.state.labelY=Q-t.state.scaledOffset[1],r&&(U=`translate(${t.state.labelX}px,${t.state.labelY}px) scale(${t.state.scaleFactor})`,U!==t.state._transform&&(t.state._transform=U,t.state._needsUpdate=!0),$=`${t.state.opacity}`,$!==t.state._opacity&&(t.state._opacity=$,t.state._needsUpdate=!0),N=`${t.state.zIndex}`,N!==t.state._zIndex&&(t.state._zIndex=N,t.state._needsUpdate=!0),t.state._visibility!=="visible"&&(t.state._visibility="visible",t.state._needsUpdate=!0))):t.state._visibility!=="hidden"&&(t.state._visibility="hidden",t.state._needsUpdate=!0)})}function ht(i){i.filter(e=>e.state._needsUpdate).forEach(e=>{var n;const t=(n=e.ref)==null?void 0:n.current;t&&(e.state._transform&&(t.style.transform=e.state._transform),e.state._opacity&&(t.style.opacity=e.state._opacity),e.state._zIndex&&(t.style.zIndex=e.state._zIndex),e.state._visibility&&(t.style.visibility=e.state._visibility))})}const ft=512,pt=512,G=new H,g=new xt;let O,J,F,K;const mt=({maxVisible:i=100,children:e})=>{const{gl:t}=It(),n=_(u=>u.instances),a=b.useRef(!1),s=_(u=>u.clear),r=b.useMemo(()=>{const u=vt().getContext("2d");if(!u)return null;const o=new wt(-1,1,1,-1,0,1),c=new St({transparent:!0}),d=new At,p=new Pt(2,2),f=new Bt(p,c);return d.add(f),{postCamera:o,postScene:d,postMaterial:c,size:new xt,texture:null,ctx:u}},[]),l=b.useMemo(()=>{const u=t.domElement.parentElement;let o=null;if(!u)throw Error("Unable to create root!");return o=document.createElement("div"),o.setAttribute("id","annotations"),o.setAttribute("style","position:absolute;top:0;left:0;z-index: 1;pointer-events:none;padding:0;width:100%;height:100%;user-select:none"),u.appendChild(o),Mt(o)},[t]);return b.useEffect(()=>(l.render(M.jsx(Nt,{})),()=>{l.unmount(),s()}),[l,s]),Vt(({gl:u,camera:o,scene:c,clock:d,pointer:p})=>{var f;if(u.getSize(g),u.clear(),u.render(c,o),r){const{postCamera:m,postScene:v,ctx:y,postMaterial:C}=r;if(y.clearRect(0,0,g.x,g.y),!n.length)return;const w=re(n,o,d,i);if(!w.length){ht(n);return}ue(w,g),a.current||requestAnimationFrame(()=>{a.current=!0;const h=w.map(x=>{const A=x.layer.anchorOcclusionRadius,P=Rt([o.position.x-x.annotation.position[0],o.position.y-x.annotation.position[1],o.position.z-x.annotation.position[2]]);return G.set(x.annotation.position[0]+P[0]*A,x.annotation.position[1]+P[1]*A,x.annotation.position[2]+P[2]*A),G.project(o),{instance:x,position:G.toArray()}});Et(u,c,o,ft,pt).then(x=>{if(x)return le(h,x,ft,pt)}).finally(()=>{a.current=!1})}),ht(n),(r.texture===null||r.texture.image.width!==g.x||r.texture.image.height!==g.y)&&(y.canvas.width=g.x,y.canvas.height=g.y,(f=r.texture)==null||f.dispose(),r.texture=new qt(y.canvas),C.map=r.texture);const S=[(p.x*.5+.5)*g.x,(-p.y*.5+.5)*g.y];w.filter(h=>!h.state.occluded&&!h.state.capped).sort((h,x)=>x.state.distance-h.state.distance).forEach(h=>{O=(h.state.screenPosition[0]*.5+.5)*g.x,F=(-h.state.screenPosition[1]*.5+.5)*g.y;let x=h.layer.anchorSize*h.state.scaleFactor,A=!1;if(Math.abs(S[0]-O)<=x&&Math.abs(S[1]-F)<=x&&(h.state.visible?A=!0:h.state.boost=!0),(h.state.labelHovered||A)&&(x*=1.5),h.layer.labelOffset>0&&h.state.visible){h.state.inTransition&&h.state.prevAnchorPosition?[J,K]=bt(h.state.prevAnchorPosition,h.state.anchorPosition,h.state.transitionTime):[J,K]=h.state.anchorPosition;let P=Math.max(.1,h.layer.connectorWidth*h.state.scaleFactor);(h.state.labelHovered||A)&&(P*=2),y.globalAlpha=h.state.opacity||0,y.beginPath(),y.moveTo(O,F),y.lineTo(J,K),y.strokeStyle=h.layer.connectorColor,y.lineWidth=P,y.stroke()}y.beginPath(),y.arc(O,F,x,0,Tt),y.globalAlpha=h.state.visible?1:.5,y.fillStyle=h.layer.anchorColor,y.fill(),y.globalAlpha=h.state.opacity||0,y.strokeStyle="black",y.lineWidth=.75,y.stroke()}),r.texture.needsUpdate=!0,u.render(v,m)}},1),M.jsx(M.Fragment,{children:e})};try{mt.displayName="Annotations",mt.__docgenInfo={description:`The Annotations component is special provider component responsible for managing 
and updating annotation layers and instances.

It allow you to register layers, using the AnnotationLayer component, and set a 
global max visible annotations.

Annotations adds point-feature labeling support, where labels are rendered as 
regular React HTML components. Anchors and connector lines are drawn to the frame buffer
after the 3D scene frame is completed.

Annotations are processed globally to support label collision, occlusion and 
ordering tests. Priority and visibillity distances can be set in the AnnotationLayer 
component and/or int the individual annotation elements.`,displayName:"Annotations",props:{maxVisible:{defaultValue:{value:"100"},description:"",name:"maxVisible",required:!1,type:{name:"number | undefined"}}}}}catch{}const tt=({id:i,name:e})=>M.jsx("div",{id:`annotation_${i}`,style:{minWidth:"150px",background:"#33333390",color:"white",textAlign:"center",overflow:"hidden",borderRadius:"4px",padding:"1px 6px",fontFamily:"sans-serif",fontSize:"12pt"},children:M.jsx("div",{style:{whiteSpace:"nowrap"},children:e})},i);try{tt.displayName="DefaultLabelComponent",tt.__docgenInfo={description:"The default component for rendering annotation labels. You can override this by\nsupplying a custom component in the `AnnotationsLayer` component.",displayName:"DefaultLabelComponent",props:{id:{defaultValue:null,description:"",name:"id",required:!0,type:{name:"string"}},name:{defaultValue:null,description:"",name:"name",required:!0,type:{name:"string"}},position:{defaultValue:null,description:"",name:"position",required:!0,type:{name:"Vec3"}},scope:{defaultValue:null,description:"",name:"scope",required:!1,type:{name:"string | undefined"}},data:{defaultValue:null,description:"",name:"data",required:!1,type:{name:"any"}},priority:{defaultValue:null,description:"",name:"priority",required:!1,type:{name:"number | undefined"}},direction:{defaultValue:null,description:"",name:"direction",required:!1,type:{name:"Vec3 | undefined"}},instanceId:{defaultValue:null,description:"",name:"instanceId",required:!0,type:{name:"string"}}}}}catch{}const yt=({id:i,name:e,priority:t=0,visible:n=!0,distanceFactor:a=100,minDistance:s=10,maxDistance:r=5e3,anchorOcclusionRadius:l=15,anchorSize:u=.25,anchorColor:o="white",connectorWidth:c=1,connectorColor:d=o||"white",labelOffset:p=100,labelComponent:f=tt,onClick:m,children:v})=>{const y=_(h=>h.createLayer),C=_(h=>h.updateLayer),W=_(h=>h.layerExist),w=b.useRef(null),S=b.useMemo(()=>({id:i,name:e,priority:t,visible:n,distanceFactor:a,minDistance:s,maxDistance:r,labelOffset:p,anchorOcclusionRadius:l,anchorSize:u,anchorColor:o,connectorWidth:c,connectorColor:d,labelComponent:f,onClick:m}),[i,e,t,n,l,u,o,c,d,s,r,p,a,f,m]);return b.useLayoutEffect(()=>{W(S.id)?C(S.id,S):w.current=y(S)},[y,C,W,S]),b.useEffect(()=>()=>{w.current&&w.current()},[]),M.jsx("group",{children:v})};try{yt.displayName="AnnotationsLayer",yt.__docgenInfo={description:"Use the AnnotationsLayer component to register and configure a layer for adding \nannotations. This needs to be added as a child of the `Annotations` component.",displayName:"AnnotationsLayer",props:{id:{defaultValue:null,description:"",name:"id",required:!0,type:{name:"string"}},name:{defaultValue:null,description:"",name:"name",required:!0,type:{name:"string"}},visible:{defaultValue:{value:"true"},description:"",name:"visible",required:!1,type:{name:"boolean | undefined"}},priority:{defaultValue:{value:"0"},description:"",name:"priority",required:!1,type:{name:"number | undefined"}},distanceFactor:{defaultValue:{value:"100"},description:"",name:"distanceFactor",required:!1,type:{name:"number | undefined"}},minDistance:{defaultValue:{value:"10"},description:"",name:"minDistance",required:!1,type:{name:"number | undefined"}},maxDistance:{defaultValue:{value:"5000"},description:"",name:"maxDistance",required:!1,type:{name:"number | undefined"}},labelOffset:{defaultValue:{value:"100"},description:"",name:"labelOffset",required:!1,type:{name:"number | undefined"}},anchorOcclusionRadius:{defaultValue:{value:"15"},description:"",name:"anchorOcclusionRadius",required:!1,type:{name:"number | undefined"}},anchorSize:{defaultValue:{value:"0.25"},description:"",name:"anchorSize",required:!1,type:{name:"number | undefined"}},anchorColor:{defaultValue:{value:"white"},description:"",name:"anchorColor",required:!1,type:{name:"string | undefined"}},connectorWidth:{defaultValue:{value:"1"},description:"",name:"connectorWidth",required:!1,type:{name:"number | undefined"}},connectorColor:{defaultValue:{value:"anchorColor || 'white'"},description:"",name:"connectorColor",required:!1,type:{name:"string | undefined"}},onClick:{defaultValue:null,description:"",name:"onClick",required:!1,type:{name:"((annotation: AnnotationComponentProps) => void) | undefined"}},labelComponent:{defaultValue:{value:`({ id, name }: AnnotationComponentProps) => {
  return (
    <div
      key={id}
      id={\`annotation_\${id}\`}
      style={{
        minWidth: '150px',
        background: '#33333390',
        color: 'white',
        textAlign: 'center',
        overflow: 'hidden',
        borderRadius: '4px',
        padding: '1px 6px',
        fontFamily: 'sans-serif',
        fontSize: '12pt',
      }}
    >
      <div style={{ whiteSpace: 'nowrap' }}>{name}</div>
    </div>
  )
}`},description:"",name:"labelComponent",required:!1,type:{name:"((props: AnnotationComponentProps) => Element) | undefined"}}}}}catch{}export{mt as A,we as a,yt as b,ve as c,Rt as n,Me as s,_ as u};
