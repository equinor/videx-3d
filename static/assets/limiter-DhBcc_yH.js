var fe=Object.defineProperty;var j=r=>{throw TypeError(r)};var de=(r,t,e)=>t in r?fe(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var H=(r,t,e)=>de(r,typeof t!="symbol"?t+"":t,e),W=(r,t,e)=>t.has(r)||j("Cannot "+e);var n=(r,t,e)=>(W(r,t,"read from private field"),e?e.call(r):t.get(r)),y=(r,t,e)=>t.has(r)?j("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(r):t.set(r,e),d=(r,t,e,i)=>(W(r,t,"write to private field"),i?i.call(r,e):t.set(r,e),e),E=(r,t,e)=>(W(r,t,"access private method"),e);var A=(r,t,e,i)=>({set _(f){d(r,t,f,e)},get _(){return n(r,t,i)}});import{g as me}from"./index-KqYmeiyw.js";class ve{constructor(t){H(this,"value");H(this,"next");this.value=t}}var I,S,L;class ye{constructor(){y(this,I);y(this,S);y(this,L);this.clear()}enqueue(t){const e=new ve(t);n(this,I)?(n(this,S).next=e,d(this,S,e)):(d(this,I,e),d(this,S,e)),A(this,L)._++}dequeue(){const t=n(this,I);if(t)return d(this,I,n(this,I).next),A(this,L)._--,t.value}peek(){if(n(this,I))return n(this,I).value}clear(){d(this,I,void 0),d(this,S,void 0),d(this,L,0)}get size(){return n(this,L)}*[Symbol.iterator](){let t=n(this,I);for(;t;)yield t.value,t=t.next}}I=new WeakMap,S=new WeakMap,L=new WeakMap;function pe(r){ee(r);const t=new ye;let e=0;const i=()=>{e<r&&t.size>0&&(t.dequeue()(),e++)},f=()=>{e--,i()},p=async(o,a,u)=>{const s=(async()=>o(...u))();a(s);try{await s}catch{}f()},g=(o,a,u)=>{new Promise(s=>{t.enqueue(s)}).then(p.bind(void 0,o,a,u)),(async()=>(await Promise.resolve(),e<r&&i()))()},l=(o,...a)=>new Promise(u=>{g(o,u,a)});return Object.defineProperties(l,{activeCount:{get:()=>e},pendingCount:{get:()=>t.size},clearQueue:{value(){t.clear()}},concurrency:{get:()=>r,set(o){ee(o),r=o,queueMicrotask(()=>{for(;e<r&&t.size>0;)i()})}}}),l}function ee(r){if(!((Number.isInteger(r)||r===Number.POSITIVE_INFINITY)&&r>0))throw new TypeError("Expected `concurrency` to be a number from 1 and up")}var ne={exports:{}};(function(r){var t=Object.prototype.hasOwnProperty,e="~";function i(){}Object.create&&(i.prototype=Object.create(null),new i().__proto__||(e=!1));function f(o,a,u){this.fn=o,this.context=a,this.once=u||!1}function p(o,a,u,s,b){if(typeof u!="function")throw new TypeError("The listener must be a function");var m=new f(u,s||o,b),v=e?e+a:a;return o._events[v]?o._events[v].fn?o._events[v]=[o._events[v],m]:o._events[v].push(m):(o._events[v]=m,o._eventsCount++),o}function g(o,a){--o._eventsCount===0?o._events=new i:delete o._events[a]}function l(){this._events=new i,this._eventsCount=0}l.prototype.eventNames=function(){var a=[],u,s;if(this._eventsCount===0)return a;for(s in u=this._events)t.call(u,s)&&a.push(e?s.slice(1):s);return Object.getOwnPropertySymbols?a.concat(Object.getOwnPropertySymbols(u)):a},l.prototype.listeners=function(a){var u=e?e+a:a,s=this._events[u];if(!s)return[];if(s.fn)return[s.fn];for(var b=0,m=s.length,v=new Array(m);b<m;b++)v[b]=s[b].fn;return v},l.prototype.listenerCount=function(a){var u=e?e+a:a,s=this._events[u];return s?s.fn?1:s.length:0},l.prototype.emit=function(a,u,s,b,m,v){var C=e?e+a:a;if(!this._events[C])return!1;var h=this._events[C],q=arguments.length,z,w;if(h.fn){switch(h.once&&this.removeListener(a,h.fn,void 0,!0),q){case 1:return h.fn.call(h.context),!0;case 2:return h.fn.call(h.context,u),!0;case 3:return h.fn.call(h.context,u,s),!0;case 4:return h.fn.call(h.context,u,s,b),!0;case 5:return h.fn.call(h.context,u,s,b,m),!0;case 6:return h.fn.call(h.context,u,s,b,m,v),!0}for(w=1,z=new Array(q-1);w<q;w++)z[w-1]=arguments[w];h.fn.apply(h.context,z)}else{var ce=h.length,Q;for(w=0;w<ce;w++)switch(h[w].once&&this.removeListener(a,h[w].fn,void 0,!0),q){case 1:h[w].fn.call(h[w].context);break;case 2:h[w].fn.call(h[w].context,u);break;case 3:h[w].fn.call(h[w].context,u,s);break;case 4:h[w].fn.call(h[w].context,u,s,b);break;default:if(!z)for(Q=1,z=new Array(q-1);Q<q;Q++)z[Q-1]=arguments[Q];h[w].fn.apply(h[w].context,z)}}return!0},l.prototype.on=function(a,u,s){return p(this,a,u,s,!1)},l.prototype.once=function(a,u,s){return p(this,a,u,s,!0)},l.prototype.removeListener=function(a,u,s,b){var m=e?e+a:a;if(!this._events[m])return this;if(!u)return g(this,m),this;var v=this._events[m];if(v.fn)v.fn===u&&(!b||v.once)&&(!s||v.context===s)&&g(this,m);else{for(var C=0,h=[],q=v.length;C<q;C++)(v[C].fn!==u||b&&!v[C].once||s&&v[C].context!==s)&&h.push(v[C]);h.length?this._events[m]=h.length===1?h[0]:h:g(this,m)}return this},l.prototype.removeAllListeners=function(a){var u;return a?(u=e?e+a:a,this._events[u]&&g(this,u)):(this._events=new i,this._eventsCount=0),this},l.prototype.off=l.prototype.removeListener,l.prototype.addListener=l.prototype.on,l.prefixed=e,l.EventEmitter=l,r.exports=l})(ne);var we=ne.exports;const ge=me(we);class ie extends Error{constructor(t){super(t),this.name="TimeoutError"}}class be extends Error{constructor(t){super(),this.name="AbortError",this.message=t}}const te=r=>globalThis.DOMException===void 0?new be(r):new DOMException(r),re=r=>{const t=r.reason===void 0?te("This operation was aborted."):r.reason;return t instanceof Error?t:te(t)};function Ee(r,t){const{milliseconds:e,fallback:i,message:f,customTimers:p={setTimeout,clearTimeout}}=t;let g,l;const a=new Promise((u,s)=>{if(typeof e!="number"||Math.sign(e)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${e}\``);if(t.signal){const{signal:m}=t;m.aborted&&s(re(m)),l=()=>{s(re(m))},m.addEventListener("abort",l,{once:!0})}if(e===Number.POSITIVE_INFINITY){r.then(u,s);return}const b=new ie;g=p.setTimeout.call(void 0,()=>{if(i){try{u(i())}catch(m){s(m)}return}typeof r.cancel=="function"&&r.cancel(),f===!1?u():f instanceof Error?s(f):(b.message=f??`Promise timed out after ${e} milliseconds`,s(b))},e),(async()=>{try{u(await r)}catch(m){s(m)}})()}).finally(()=>{a.clear(),l&&t.signal&&t.signal.removeEventListener("abort",l)});return a.clear=()=>{p.clearTimeout.call(void 0,g),g=void 0},a}function xe(r,t,e){let i=0,f=r.length;for(;f>0;){const p=Math.trunc(f/2);let g=i+p;e(r[g],t)<=0?(i=++g,f-=p+1):f=p}return i}var T;class Ie{constructor(){y(this,T,[])}enqueue(t,e){e={priority:0,...e};const i={priority:e.priority,id:e.id,run:t};if(this.size===0||n(this,T)[this.size-1].priority>=e.priority){n(this,T).push(i);return}const f=xe(n(this,T),i,(p,g)=>g.priority-p.priority);n(this,T).splice(f,0,i)}setPriority(t,e){const i=n(this,T).findIndex(p=>p.id===t);if(i===-1)throw new ReferenceError(`No promise function with the id "${t}" exists in the queue.`);const[f]=n(this,T).splice(i,1);this.enqueue(f.run,{priority:e,id:t})}dequeue(){const t=n(this,T).shift();return t==null?void 0:t.run}filter(t){return n(this,T).filter(e=>e.priority===t.priority).map(e=>e.run)}get size(){return n(this,T).length}}T=new WeakMap;var $,k,O,V,F,Y,_,D,x,R,P,M,N,B,U,c,se,ue,ae,oe,he,G,X,Z,J,le,K;class Te extends ge{constructor(e){var i,f;super();y(this,c);y(this,$);y(this,k);y(this,O,0);y(this,V);y(this,F);y(this,Y,0);y(this,_);y(this,D);y(this,x);y(this,R);y(this,P,0);y(this,M);y(this,N);y(this,B);y(this,U,1n);H(this,"timeout");if(e={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:Ie,...e},!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${((i=e.intervalCap)==null?void 0:i.toString())??""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${((f=e.interval)==null?void 0:f.toString())??""}\` (${typeof e.interval})`);d(this,$,e.carryoverConcurrencyCount),d(this,k,e.intervalCap===Number.POSITIVE_INFINITY||e.interval===0),d(this,V,e.intervalCap),d(this,F,e.interval),d(this,x,new e.queueClass),d(this,R,e.queueClass),this.concurrency=e.concurrency,this.timeout=e.timeout,d(this,B,e.throwOnTimeout===!0),d(this,N,e.autoStart===!1)}get concurrency(){return n(this,M)}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);d(this,M,e),E(this,c,J).call(this)}setPriority(e,i){n(this,x).setPriority(e,i)}async add(e,i={}){return i.id??(i.id=(A(this,U)._++).toString()),i={timeout:this.timeout,throwOnTimeout:n(this,B),...i},new Promise((f,p)=>{n(this,x).enqueue(async()=>{var g;A(this,P)._++,A(this,O)._++;try{(g=i.signal)==null||g.throwIfAborted();let l=e({signal:i.signal});i.timeout&&(l=Ee(Promise.resolve(l),{milliseconds:i.timeout})),i.signal&&(l=Promise.race([l,E(this,c,le).call(this,i.signal)]));const o=await l;f(o),this.emit("completed",o)}catch(l){if(l instanceof ie&&!i.throwOnTimeout){f();return}p(l),this.emit("error",l)}finally{E(this,c,ae).call(this)}},i),this.emit("add"),E(this,c,G).call(this)})}async addAll(e,i){return Promise.all(e.map(async f=>this.add(f,i)))}start(){return n(this,N)?(d(this,N,!1),E(this,c,J).call(this),this):this}pause(){d(this,N,!0)}clear(){d(this,x,new(n(this,R)))}async onEmpty(){n(this,x).size!==0&&await E(this,c,K).call(this,"empty")}async onSizeLessThan(e){n(this,x).size<e||await E(this,c,K).call(this,"next",()=>n(this,x).size<e)}async onIdle(){n(this,P)===0&&n(this,x).size===0||await E(this,c,K).call(this,"idle")}get size(){return n(this,x).size}sizeBy(e){return n(this,x).filter(e).length}get pending(){return n(this,P)}get isPaused(){return n(this,N)}}$=new WeakMap,k=new WeakMap,O=new WeakMap,V=new WeakMap,F=new WeakMap,Y=new WeakMap,_=new WeakMap,D=new WeakMap,x=new WeakMap,R=new WeakMap,P=new WeakMap,M=new WeakMap,N=new WeakMap,B=new WeakMap,U=new WeakMap,c=new WeakSet,se=function(){return n(this,k)||n(this,O)<n(this,V)},ue=function(){return n(this,P)<n(this,M)},ae=function(){A(this,P)._--,E(this,c,G).call(this),this.emit("next")},oe=function(){E(this,c,Z).call(this),E(this,c,X).call(this),d(this,D,void 0)},he=function(){const e=Date.now();if(n(this,_)===void 0){const i=n(this,Y)-e;if(i<0)d(this,O,n(this,$)?n(this,P):0);else return n(this,D)===void 0&&d(this,D,setTimeout(()=>{E(this,c,oe).call(this)},i)),!0}return!1},G=function(){if(n(this,x).size===0)return n(this,_)&&clearInterval(n(this,_)),d(this,_,void 0),this.emit("empty"),n(this,P)===0&&this.emit("idle"),!1;if(!n(this,N)){const e=!n(this,c,he);if(n(this,c,se)&&n(this,c,ue)){const i=n(this,x).dequeue();return i?(this.emit("active"),i(),e&&E(this,c,X).call(this),!0):!1}}return!1},X=function(){n(this,k)||n(this,_)!==void 0||(d(this,_,setInterval(()=>{E(this,c,Z).call(this)},n(this,F))),d(this,Y,Date.now()+n(this,F)))},Z=function(){n(this,O)===0&&n(this,P)===0&&n(this,_)&&(clearInterval(n(this,_)),d(this,_,void 0)),d(this,O,n(this,$)?n(this,P):0),E(this,c,J).call(this)},J=function(){for(;E(this,c,G).call(this););},le=async function(e){return new Promise((i,f)=>{e.addEventListener("abort",()=>{f(e.reason)},{once:!0})})},K=async function(e,i){return new Promise(f=>{const p=()=>{i&&!i()||(this.off(e,p),f())};this.on(e,p)})};const _e=pe(50),Pe=new Te({concurrency:20}),qe=r=>_e(r),Oe=(r,t=0)=>Pe.add(r,{priority:t});export{qe as l,Oe as q};
